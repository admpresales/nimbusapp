#!/bin/bash

IMAGE_FILE="env"

function usage()
{
   echo "Usage:"
   echo -e "\t./nimbusapp [product_name|-i <image>] [-s|--set <ARG=value>] -v  up|down|start|stop"
   echo -e "\t\tproduct_name - is software product name"
   echo -e "\t\t-h --help"
   echo -e "\t\t-i - use a specific image to run. Short name (assumes admpresales)"
   echo -e "\t\t\texample: pass ${PRODUCT}:x.x.x only out of admpresales/${PRODUCT}:x.x.x"
   echo -e "\t\t-s | --set - enables you to set(override) default arguments"
   echo -e "\t\t-v - Intellij only - volume mounts .m2 and IdeaProject for access from the NimbusServer - EXPERIMENTAL NOT FOR CASUAL USERS"
   echo -e "\t\t-p - docker-compose project name to use - EXPERIMENTAL NOT RECOMMENDED FOR CASUAL USERS"
   echo -e "\t\tup - starts up a container (pulls down image if not present)"
   echo -e "\t\tdown - stops AND TERMINATES (removes) the container(s)"
   echo -e "\t\tstart - starts existing container(s)"
   echo -e "\t\tstop - stops existing container(s)"
   echo ""
}

function multiple_actions(){
   echo "You can only perform one action.  Current action is '${ACTION}' and you attempting to add '$1'"
   echo "Aborting"
   usage;
   exit 1;
}

function product_exists(){
   #if we find an entry, return 0 for success, else 1 for failure
   if [[ `grep "^$1.dockerapp " ${IMAGE_FILE}| wc -l` -eq 1 ]]
   then
      echo 0
   else
      echo 1
   fi
}

# create folders to use for mount points
# currently not leverated by Intellij
function create_intellij_mount_points (){
   IDEA="IdeaProjects_docker"
   # if the folder doesn't exist, create it so it is owned by the user
   if [ ! -d "${HOME}/${IDEA}" ]
   then
      mkdir ${HOME}/${IDEA}
   fi

   if [ ! -d "${HOME}/.m2" ]
   then
      mkdir ${HOME}/.m2
   fi
}

PRODUCT=""
PROJECT_NAME=""
ACTION=""
ACTION_COUNT=0
VOLUME_MOUNT=""

IMAGE_COUNT=`echo "$@"|grep -o "\-i"|wc -l`
if [[ ${IMAGE_COUNT} -eq 0 ]]
then
   if [[ $(product_exists $1) -eq 1 ]]
   then
      echo "Could not find that product."
      usage
      exit 1
   else
      PRODUCT=$1.dockerapp
      shift
   fi
fi

if [[ ${IMAGE_COUNT} -gt 1 ]]
then
   echo "Only allowed to pass one image to the script"
   usage
   exit 1
fi

while [[ "$1" != "" ]]; do
   PARAM=$1
   VALUE=$2
   case $PARAM in
      -h | --help)
         usage
         exit
         ;;
      -i)
         if [[ ! -z ${PRODUCT} ]]
         then
            echo "Not allowed to pass a product name and an image name at the same time."
            usage
            exit
         fi
         IMAGE="admpresales/$2"
         shift
         shift
         ;;
      -s)
         ARGS="${ARGS} $1 $2"
         shift
         shift
         ;;
      -v)
         # check to see if intellij is being called.  since args can appear in differ order, checking all 3 places:
         # product, image or if it is a command not yet processed
         if [[ (`echo ${PRODUCT}|grep "intellij"| wc -l` -eq 1) || (`echo ${IMAGE}|grep "intellij"| wc -l` -eq 1) || (`echo "$@" |grep "intellij"| wc -l` -eq 1)]]
         then
            VOLUME_MOUNT="-e '\$a\    - ${HOME}/.m2:/home/demo/.m2' -e '\$a\    - ${HOME}/${IDEA}:/home/demo/IdeaProjects'"
            create_intellij_mount_points
         else
            echo "The '-v' option is only available with Intellij at this time.  Ignoring."
         fi
         shift
         ;;
      -p)
         PROJECT_NAME=$2
         shift
         shift
         ;;
      up)
         #If ACTION has already been set
         if [[ ${ACTION_COUNT} -gt 0 ]]; then
            multiple_actions
         else
            ACTION_COUNT=1
            ACTION="up -d"
            shift
         fi
         ;;
      down)
         #If ACTION has already been set
         if [[ ${ACTION_COUNT} -gt 0 ]]; then
            multiple_actions
         else
            ACTION_COUNT=1
            ACTION="down"
            shift
         fi
         ;;
      start)
         #If ACTION has already been set
         if [[ ${ACTION_COUNT} -gt 0 ]]; then
            multiple_actions
         else
            ACTION_COUNT=1
            ACTION="start"
            shift
         fi
         ;;
      stop)
         #If ACTION has already been set
         if [[ ${ACTION_COUNT} -gt 0 ]]; then
            multiple_actions
         else
            ACTION_COUNT=1
            ACTION="stop"
            shift
         fi
         ;;
      *)
         echo "Invalid agument passed: $1"
         echo "Make sure your are NOT passing a product AND and image (-i) at the same time"
         echo "Aborting"
         usage
         exit 1
   esac
done

if [[ -z ${ACTION} ]]
then
   echo "You must specify an action up|down|start|stop"
   usage
   exit 1
fi

if [[ -z ${IMAGE} ]]
then
   if [ `grep "^${PRODUCT} " ${IMAGE_FILE}| wc -l` -eq 1 ]
   then
      IMAGE=`grep "^${PRODUCT} " ${IMAGE_FILE}|awk '{print $2}'`
   else
      echo "Your env file contains multiple entires for ${PRODUCT}"
      exit 1
   fi
fi

#create a project name for the docker-compose based on the image name.
if [[ -z ${PROJECT_NAME} ]]
then
   PROJECT_NAME=`echo ${IMAGE}|sed -r 's|\w+/||'|sed 's/:/_/'`
fi

echo -e "Starting ${PRODUCT} using: \n\t${IMAGE}"

if [[ -z ${VOLUME_MOUNT} ]]
then
   echo -e "\tUsing docker-app render ${IMAGE} ${ARGS}| docker-compose -p ${PROJECT_NAME} -f - ${ACTION}"
   docker-app render ${IMAGE} ${ARGS}| docker-compose -p ${PROJECT_NAME} -f - ${ACTION}
else
   # To-Do
   # think of a better way to provide this capability
   echo -e "\tUsing docker-app render ${IMAGE} ${ARGS} | sed -e '\$a\    - ${HOME}/.m2:/home/demo/.m2' -e '\$a\    - ${HOME}/${IDEA}:/home/demo/IdeaProjects' |  docker-compose -p intellij -f - up -d"
   docker-app render ${IMAGE} ${ARGS}| sed -e "\$a\    - ${HOME}/.m2:/home/demo/.m2" -e "\$a\    - ${HOME}/${IDEA}:/home/demo/IdeaProjects" | docker-compose -p ${PROJECT_NAME} -f - ${ACTION}
fi
