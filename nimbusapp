#!/bin/bash

function usage()
{
   echo "Usage: nimbusapp <IMAGE>:<VERSION> [OPTIONS] COMMAND"
   echo -e ""
   echo -e "Options:"
   echo -e "  IMAGE      The Docker App file you wish to run. If no repository is provided, admpresales is assumed."
   echo -e "             dockerapp is added if not explicitly stated."
   echo -e "  VERSION    The version of the Docker App file you wish to run."
   echo -e "  -s, --set  Enables you to set(override) default arguments"
   echo -e "  -v         Mounts volume for IdeaProject in IntelliJ container into user's home directory - EXPERIMENTAL: ONLY USE IF YOU UNDERSTAND VOLUME MOUNTS"
   echo -e "  -m         Mounts volume for .m2 in IntelliJ container into user's home directory - EXPERIMENTAL: ONLY USE IF YOU UNDERSTAND VOLUME MOUNTS"
   echo -e "  -p         Docker-compose project name to use - EXPERIMENTAL NOT RECOMMENDED FOR CASUAL USERS"
   echo -e ""
   echo -e "Commands:"
   echo -e "  down     Stop and remove containers"
   echo -e "  inspect  Shows metadata and settings for a given application"
   echo -e "  logs     Shows logs for containers"
   echo -e "  ps       Lists containers"
   echo -e "  pull     Pull service images"
   echo -e "  render   Render the Compose file for the application"
   echo -e "  rm       Remove stopped containers"
   echo -e "  restart  Restart containers"
   echo -e "  start    Start existing containers"
   echo -e "  stop     Stop existing containers"
   echo -e "  up       Creates and start containers"
}

function product_exists(){
   #if we find an entry, return 0 for success, else 1 for failure
   #forcing a short name standard since someone could pass intellij or intellij.dockerapp
   image=$(echo $IMAGE | cut -d'.' -f1 )
   if [[ $(grep "^${image}" ${ENV_FILE} | wc -l) -eq 1 ]]
   then
      return 0
   else
      return 1
   fi
}

# create folders to use for mount points
# currently not leverated by Intellij
function create_intellij_mount_points (){
   # if the folder doesn't exist, create it so it is owned by the user
   if [[ ! -d "${HOME}/${IDEA}" ]]
   then
      mkdir ${HOME}/${IDEA}
   fi

   if [[ ! -d "${HOME}/.m2" ]]
   then
      mkdir ${HOME}/.m2
   fi
}

function prompt_yn() {
  local PROMPT_TEXT=$"${1-Continue?} [y/n]"
  local USER_ANSWER

  echo -n "${PROMPT_TEXT} "

  while read USER_ANSWER; do
    case "${USER_ANSWER}" in
      [yY]*)
        return 0
        ;;
      [nN]*)
        return 1
        ;;
    esac

    echo -n "${PROMPT_TEXT} "
  done
}

function create_network() {
    if [[ -z "$(docker network ls -qf "name=${NETWORK_NAME}")" ]]; then
        docker network create --subnet "${NETWORK_SUBNET}" --gateway "${NETWORK_GATEWAY}" "${NETWORK_NAME}"
    fi
}

REPOSITORY="admpresales"
VERSION="latest"
PROJECT=""
VOLUME_MOUNT_IDEA=""
VOLUME_MOUNT_M2=""
IDEA="IdeaProjects_docker"

COMPOSE_COMMAND="${NIMBUS_COMPOSE_COMMAND-docker-compose}"
COMPOSE_ACTION=""
COMPOSE_ARGS="${NIMBUS_COMPOSE_ARGS}"

DOCKERAPP_COMMAND="${NIMBUS_DOCKERAPP_COMMAND-docker-app}"
DOCKERAPP_ACTION=""
DOCKERAPP_ARGS="${NIMBUS_DOCKERAPP_ARGS}"

NIMBUS_BASEDIR="${NIMBUS_BASEDIR-$HOME/.nimbusapp}"
NIMBUS_DOCKERHUB_URL="${NIMBUS_DOCKERHUB_URL-https://hub.docker.com}"
NIMBUS_DOCKERHUB_TIMEOUT="${NIMBUS_DOCKERHUB_TIMEOUT-10}"

NETWORK_NAME="${NETWORK_NAME-demo-net}"
NETWORK_SUBNET="${NETWORK_SUBNET-172.50.0.0/16}"
NETWORK_GATEWAY="${NETWORK_GATEWAY-172.50.0.1}"

ENV_FILE="${NIMBUS_BASEDIR}/apps.config"

IMAGE="$1"

shift
if [[ "${IMAGE}" = *"help"* ]]; then
  usage
  exit 0
fi

if [[ "$IMAGE" == *\/* ]]; then
  REPOSITORY=$(echo $IMAGE | cut -d'/' -f1 )
  IMAGE=$(echo $IMAGE | cut -d'/' -f2 )
fi

if [[ "$IMAGE" == *:* ]]; then
  VERSION=$(echo $IMAGE | cut -d':' -f2 )
  IMAGE=$(echo $IMAGE | cut -d':' -f1 )
elif [[ -e $ENV_FILE ]]; then
  product_exists
  prodExists=$?
  if [[ $prodExists -eq 0 ]]; then
    #ensuring uniform comparision since someone could pass intillij or intellij.dockerapp
    IMAGE=$(echo $IMAGE | cut -d'.' -f1 )".dockerapp"
    VERSION=$(grep "^${IMAGE}" ${ENV_FILE} | cut -d':' -f2 )
    echo "Using ${IMAGE}:${VERSION} version found in ${ENV_FILE}"
  else
    echo "Not able to find ${IMAGE} in ${ENV_FILE}.  Will attempt to start using ${IMAGE}:${VERSION}"
  fi
fi

# IMAGE="admpresales/${IMAGE}.dockerapp"

while [[ "$1" != "" ]]; do
  PARAM="$1"
  VALUE="$2"

  case "$PARAM" in
    -h | --help | help)
      usage
      exit 0
      ;;
      -s | --set)
         DOCKERAPP_ARGS="${DOCKERAPP_ARGS} $PARAM $VALUE"
         shift
         shift
         ;;
      -v)
         # check to see if intellij is being called.
        if [[ "${IMAGE}" == *intellij* ]]
         then
            # the \ \ forces spaces which are needed for the sed statment below for proper docker-compose format
            VOLUME_MOUNT_IDEA="\ \ \ \ - type: bind\n\ \ \ \ \ \ source: ${HOME}\/${IDEA}\n\ \ \ \ \ \ target: \/home\/demo/\/IdeaProjects"
            create_intellij_mount_points
         else
            echo "The '-v' option is only available with Intellij at this time.  Ignoring."
         fi
         shift
         ;;
      -m)
         # check to see if intellij is being called.
         if [[ "${IMAGE}" == *"intellij"* ]]
         then
            # the \ \ forces spaces which are needed for the sed statment below for proper docker-compose format
            VOLUME_MOUNT_M2="\ \ \ \ - type: bind\n\ \ \ \ \ \ source: ${HOME}\/\.m2\n\ \ \ \ \ \ target: \/home\/demo\/\.m2"
            create_intellij_mount_points
         else
            echo "The '-m' option is only available with Intellij at this time.  Ignoring."
         fi
         shift
         ;;
      -p)
         PROJECT="${VALUE}"
         shift
         shift
         ;;
      render|inspect)
        DOCKERAPP_ACTION="${PARAM}"
        shift
        break
        ;;
      down | start | stop | ps | rm | logs | restart | pull )
        DOCKERAPP_ACTION="render"
        COMPOSE_ACTION="${PARAM}"
        shift
        break
        ;;
      up)
        DOCKERAPP_ACTION="render"
        COMPOSE_ACTION="up -d"
        shift
        break
        ;;
      *)
       echo "Invalid argument passed: $1"
       usage
       exit 1
   esac
done

if [[ -z "${COMPOSE_ACTION}" && -z "${DOCKERAPP_ACTION}" ]]; then
   echo "You must specify a command"
   usage
   exit 1
fi

create_network

#create a project name for the docker-compose based on the image name.
if [[ -z ${PROJECT} ]]; then
   PROJECT=`echo ${IMAGE}|sed -r 's|\w+/||'|sed 's/:/_/'`
fi

COMPOSE_ARGS="$@"
COMPOSE_DIR="${HOME}/.nimbusapp/cache/${PROJECT}/${REPOSITORY}/${IMAGE}/${VERSION}"
COMPOSE_FILE="${COMPOSE_DIR}/${IMAGE}.yml"
COMPOSE_BACKUP="${COMPOSE_FILE}.bk"

if [[ -n "${DOCKERAPP_ACTION}" ]]; then
   if curl -s --connect-timeout "${NIMBUS_DOCKERHUB_TIMEOUT}" "${NIMBUS_DOCKERHUB_URL}" > /dev/null 2>&1; then
       DOCKERAPP_COMMAND="${DOCKERAPP_COMMAND} ${DOCKERAPP_ACTION} ${DOCKERAPP_ARGS} ${REPOSITORY}/${IMAGE}:${VERSION}"

       if [[ "$DOCKERAPP_ACTION" == "render" ]]; then
          DOCKERAPP_COMMAND="${DOCKERAPP_COMMAND} > ${COMPOSE_FILE}"

          # Backup previous successful attempts in case this try fails
          # Ignore empty files (assume previous failure)
          if [[ -s "${COMPOSE_FILE}" ]]; then
            mv -v "${COMPOSE_FILE}" "${COMPOSE_BACKUP}"
          else
            rm -vf "${COMPOSE_FILE}"
          fi
       fi # action == render

       mkdir -p "${COMPOSE_DIR}"

       echo
       echo "Running: ${DOCKERAPP_COMMAND}"

       if ! eval "${DOCKERAPP_COMMAND}"; then
          # Something went wrong, replace the compose backup
          if [[ -f "${COMPOSE_BACKUP}" ]]; then
            mv "${COMPOSE_BACKUP}" "${COMPOSE_FILE}"
          fi

          echo "ERROR: Could not render" >&2
          exit 1
       fi # eval

       if [[ -n "${VOLUME_MOUNT_IDEA}" ]]; then
         echo "Mounting IDEA: ${VOLUME_MOUNT_IDEA}"
         sed -i "/volumes:/a ${VOLUME_MOUNT_IDEA}" "${COMPOSE_FILE}"
       fi

       if [[ -n "${VOLUME_MOUNT_M2}" ]]; then
         echo "Mounting M2: ${VOLUME_MOUNT_M2}"
         sed -i "/volumes:/a ${VOLUME_MOUNT_M2}" "${COMPOSE_FILE}"
       fi


       if [[ "$DOCKERAPP_ACTION" == "render" && -z "${COMPOSE_ACTION}" ]]; then
          cat "${COMPOSE_FILE}"
       fi
   else # curl check
       if [[ ! -f "${COMPOSE_FILE}" ]]; then
          echo "ERROR: No connection to Docker Hub: ${NIMBUS_DOCKERHUB_URL} (${NIMBUS_DOCKERHUB_TIMEOUT}s)" >&2
          exit 1
       else
          echo "No connection to Docker Hub (${NIMBUS_DOCKERHUB_URL}), using cached file: ${COMPOSE_FILE}" >&2
       fi
   fi # curl check
fi

if [[ -n "${COMPOSE_ACTION}" ]]; then
  COMPOSE_COMMAND="${COMPOSE_COMMAND} -p ${PROJECT} -f ${COMPOSE_FILE} ${COMPOSE_ACTION} ${COMPOSE_ARGS}"
  echo "Running: ${COMPOSE_COMMAND}"
  eval "${COMPOSE_COMMAND}"
fi
